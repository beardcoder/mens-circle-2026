# Deployment Guide - Unified Next.js + Payload CMS

## Quick Start (Development)

```bash
cd cms
cp .env.example .env
# Edit .env with your configuration
npm install
npm run dev
```

Access:
- Frontend: http://localhost:3001
- Admin: http://localhost:3001/admin
- API: http://localhost:3001/api

## Production Deployment

### Using Docker Compose (Recommended for Coolify)

1. **Configure Environment Variables in Coolify**:
   - `SERVICE_PASSWORD_64_PAYLOAD` (auto-generated by Coolify)
   - `SERVICE_FQDN_CMS_3001` (auto-generated by Coolify)
   - `SMTP_HOST`, `SMTP_USER`, `SMTP_PASS` (for email)
   - `ADMIN_EMAIL` (for notifications)
   - Optional: `NEXT_PUBLIC_UMAMI_*` (for analytics)

2. **Deploy**:
   ```bash
   docker-compose up --build
   ```

3. **Volumes**:
   - `cms-media` - Media uploads
   - `cms-data` - SQLite database

### Manual Deployment

1. **Install Dependencies**:
   ```bash
   cd cms
   npm install
   ```

2. **Configure Environment**:
   ```bash
   cp .env.example .env
   # Edit .env with production values
   ```

3. **Build**:
   ```bash
   npm run build
   ```

4. **Start**:
   ```bash
   npm start
   ```

## Environment Variables

### Required

```env
DATABASE_URL=file:./data/payload.db
PAYLOAD_SECRET=<64-char-random-string>
NODE_ENV=production
```

### Recommended

```env
NEXT_PUBLIC_SITE_URL=https://your-domain.com
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your-email@example.com
SMTP_PASS=your-password
MAIL_FROM=noreply@your-domain.com
ADMIN_EMAIL=admin@your-domain.com
```

### Optional (Analytics)

```env
NEXT_PUBLIC_UMAMI_ENABLED=true
NEXT_PUBLIC_UMAMI_WEBSITE_ID=your-website-id
NEXT_PUBLIC_UMAMI_SCRIPT_URL=https://cloud.umami.is/script.js
```

## First-Time Setup

After deployment, create an admin user:

1. Go to `/admin`
2. Create your first user
3. Log in and configure:
   - Site Settings (Global)
   - Create/edit Pages
   - Add Events, Testimonials, etc.

## Database

- **Type**: SQLite
- **Location**: `cms/data/payload.db`
- **Backup**: Regularly backup the `data/` directory
- **Migrations**: Handled automatically by Payload

## Performance Tips

1. **Enable Image Optimization**: Next.js handles this automatically
2. **Use CDN**: Serve static assets from CDN in production
3. **Database**: SQLite is fast for this use case; upgrade to PostgreSQL if needed
4. **Caching**: Next.js caches pages automatically

## Monitoring

- Check logs: `docker-compose logs -f cms`
- Admin health: `/admin`
- API health: `/api/health` (if enabled)

## Troubleshooting

### Build Errors
- Ensure Node.js 18+ is installed
- Clear cache: `rm -rf .next node_modules && npm install`
- Check TypeScript: `npm run type-check`

### Database Issues
- Ensure `data/` directory exists and is writable
- Check `DATABASE_URL` in `.env`
- Verify SQLite permissions

### Runtime Errors
- Check environment variables
- Verify SMTP settings (for emails)
- Check Docker logs
- Ensure port 3001 is available

## Security Checklist

✅ Set strong `PAYLOAD_SECRET`  
✅ Use HTTPS in production  
✅ Configure SMTP securely  
✅ Regularly update dependencies  
✅ Backup database regularly  
✅ Restrict admin access  
✅ Enable rate limiting (optional)  

## Updating

```bash
cd cms
npm update
npm run build
npm start
```

Or with Docker:
```bash
docker-compose down
docker-compose up --build -d
```

---

Need help? Check the [Migration Guide](MIGRATION.md) or [Payload Documentation](https://payloadcms.com/docs).
